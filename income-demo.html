<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<title>Income</title>
<style>
body{font-family:Arial;background:#f5f5f5;margin:0}
header,footer{
 background:#2e7d32;color:#fff;padding:12px 20px;
 display:flex;justify-content:space-between;align-items:center
}
header a,footer a{color:#fff;text-decoration:none;font-weight:bold}
.container{
 max-width:1200px;margin:auto;background:#fff;padding:20px;min-height:70vh
}
h1{text-align:center;font-size:32px;color:#2e7d32;margin:15px 0}

table{width:100%;border-collapse:collapse;table-layout:fixed}
th,td{border:1px solid #ccc;padding:8px;text-align:center;font-size:14px}
th{background:#e8f5e9}

.col-prod{width:180px}
.col-unit{width:80px}
.col-cost{width:140px}
.col-qty{width:110px}
.col-rate{width:110px}
.col-sales{width:140px}
.col-profit{width:140px}

td input{
 width:100%;box-sizing:border-box;padding:5px
}
.note{font-size:12px;color:#555;margin-top:8px}
</style>
</head>

<body>

<header>
  <a href="expense-demo.html">⬅️ Expenses</a>
  <span>Farmer Base BP Engine</span>
  <a href="profit-loss.html">Profit ➡️</a>
</header>

<div class="container">
<h1>INCOME</h1>

<table>
<thead>
<tr>
  <th class="col-prod">उत्पादन</th>
  <th class="col-unit">इकाई</th>
  <th class="col-cost">उत्पादन लागत (Auto)</th>
  <th class="col-qty">बिक्री परिमाण</th>
  <th class="col-rate">बिक्री दर</th>
  <th class="col-sales">कुल आम्दानी</th>
  <th class="col-profit">नाफा</th>
</tr>
</thead>
<tbody id="incomeBody"></tbody>
</table>

<div class="note">
✔️ उत्पादन लागत Expense बाट अटो आएको हो ।<br>
✔️ यहाँ खर्च हालिँदैन — बजार अनुसार बिक्री परिमाण र दर मात्र हाल्नुहोस् ।
</div>
</div>

<footer>
  <a href="expense-demo.html">⬅️ Expenses</a>
  <span>Income Module</span>
  <a href="profit-loss.html">Profit ➡️</a>
</footer>

<script>
/* ================= LOAD DATA ================= */
const productions = JSON.parse(localStorage.getItem("productions")) || [];
const expenses = JSON.parse(localStorage.getItem("expenses")) || [];
let incomes = JSON.parse(localStorage.getItem("incomes")) || {};

/* ================= HELPERS ================= */
// Allocate expense amount to productions
function allocateToProductions(exp){
 const mapped = exp.map || {};
 const keys = Object.keys(mapped);
 if(keys.length===0) return {}; // not allocated

 // percentage-based or equal split
 let totalWeight = 0;
 keys.forEach(k=>{
  totalWeight += typeof mapped[k]==="number" ? mapped[k] : 1;
 });

 const totalCost =
  exp.type==="fixed"
   ? ((exp.qty*exp.rate)/(exp.life||1))
   : (exp.qty*exp.rate);

 const result = {};
 keys.forEach(k=>{
  const w = typeof mapped[k]==="number" ? mapped[k] : 1;
  result[k] = totalCost * (w/totalWeight);
 });
 return result;
}

// Compute production cost map
function computeProductionCosts(){
 const costMap = {};
 productions.forEach(p=>costMap[p.id]=0);

 expenses.forEach(e=>{
  const alloc = allocateToProductions(e);
  Object.keys(alloc).forEach(pid=>{
   if(costMap[pid]!==undefined){
    costMap[pid] += alloc[pid];
   }
  });
 });

 return costMap;
}

/* ================= RENDER ================= */
function render(){
 const tb = document.getElementById("incomeBody");
 tb.innerHTML="";

 const costMap = computeProductionCosts();

 productions.forEach(p=>{
  const cost = costMap[p.id] || 0;
  const inc = incomes[p.id] || { qty:0, rate:0 };

  const sales = inc.qty * inc.rate || 0;
  const profit = sales - cost;

  tb.innerHTML += `
<tr>
<td>${p.name}</td>
<td>${p.unit}</td>
<td>${cost.toFixed(2)}</td>
<td><input type="number" value="${inc.qty}"
    onchange="updateIncome('${p.id}','qty',this.value)"></td>
<td><input type="number" value="${inc.rate}"
    onchange="updateIncome('${p.id}','rate',this.value)"></td>
<td>${sales.toFixed(2)}</td>
<td>${profit.toFixed(2)}</td>
</tr>`;
 });
}

function updateIncome(pid, field, value){
 if(!incomes[pid]) incomes[pid]={qty:0,rate:0};
 incomes[pid][field] = Number(value)||0;
 localStorage.setItem("incomes", JSON.stringify(incomes));
 render();
}

render();
</script>

</body>
</html>
