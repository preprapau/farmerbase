<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<title>Profit & Loss (Demo)</title>

<style>
body{font-family:Arial;background:#f5f5f5;margin:0}
header,footer{
 background:#2e7d32;color:#fff;padding:12px 20px;
 display:flex;justify-content:space-between;align-items:center
}
header a,footer a{color:#fff;text-decoration:none;font-weight:bold}

.container{
 max-width:1200px;
 margin:auto;
 background:#fff;
 padding:20px;
 min-height:70vh
}

h1{text-align:center;font-size:32px;color:#2e7d32;margin:15px 0}
h2{margin-top:25px;color:#333}

.summary{
 background:#f1f8e9;
 padding:15px;
 font-size:16px;
 margin-bottom:20px
}

table{
 width:100%;
 border-collapse:collapse;
 table-layout:fixed
}
th,td{
 border:1px solid #ccc;
 padding:8px;
 text-align:right;
 font-size:14px
}
th:first-child,td:first-child{text-align:left}
th{background:#e8f5e9}

.pos{color:#2e7d32;font-weight:bold}
.neg{color:#c62828;font-weight:bold}
.note{font-size:13px;color:#555;margin-top:10px}
</style>
</head>

<body>

<header>
  <a href="income-demo.html">тмЕя╕П рдЖрдореНрджрд╛рдиреА рд╡рд┐рд╡рд░рдг</a>
  <span>рдирд╛рдлрд╛/рдиреЛрдХреНрд╕рд╛рди рд╣рд┐рд╢рд╛рд╡</span>
  <a href="profit-distribution.html">рдирд╛рдлрд╛ рд╡рд┐рддрд░рдг</a>
</header>

<div class="container">

<!-- ================= SUMMARY ================= -->
<div class="summary">
  ЁЯФ╣ <b>рдХреБрд▓ рдЖрдореНрджрд╛рдиреА:</b>
  <span id="totalIncome">0</span><br>

  ЁЯФ╣ <b>рдХреБрд▓ рдЪрд╛рд▓реБ рдЦрд░реНрдЪ:</b>
  <span id="totalVariable">0</span><br>

  ЁЯФ╣ <b>рдХреБрд▓ рд╡рд╛рд░реНрд╖рд┐рдХ рд╣реНрд░рд╛рд╕:</b>
  <span id="totalDep">0</span><br>

  <hr>

  ЁЯФ╣ <b>рд╕рдЮреНрдЪрд╛рд▓рди рдирд╛рдлрд╛ (Operating Profit):</b>
  <span id="operatingProfit">0</span><br>

  ЁЯФ╣ <b>рд╡реНрдпрд╛рдЬ рдЦрд░реНрдЪ:</b>
  <span id="totalInterest">0</span><br>

  <hr>

  ЁЯФ╣ <b>рд╢реБрджреНрдз рдирд╛рдлрд╛ / рдиреЛрдХреНрд╕рд╛рди:</b>
  <span id="netProfit" class="pos">0</span>
</div>

<h2>рд╡рд┐рд╡рд░рдг</h2>
<table>
<thead>
<tr>
  <th>рд╢реАрд░реНрд╖рдХ</th>
  <th>рд░рдХрдо</th>
</tr>
</thead>
<tbody id="plBody"></tbody>
</table>

<div class="note">
тЬФя╕П рдпреЛ Demo view рд╣реЛ тАФ рд╕рдмреИ рдЧрдгрдирд╛ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рдбреЗрдЯрд╛ рдмрд╛рдЯ рдЖрдПрдХреЛ рд╣реЛ ред<br>
тЬФя╕П рдЪрд╛рд▓реБ рдЦрд░реНрдЪ = рд╡рд╛рд╕реНрддрд╡рд┐рдХ рдЦрд░реНрдЪ ред<br>
тЬФя╕П рд╕реНрдерд┐рд░ рдЦрд░реНрдЪ = рд╡рд╛рд░реНрд╖рд┐рдХ рд╣реНрд░рд╛рд╕рдХрдЯреНрдЯреА рдорд╛рддреНрд░ ред<br>
тЬФя╕П рд╡реНрдпрд╛рдЬ = Financing Cost (рдЙрддреНрдкрд╛рджрди рд▓рд╛рдЧрдд рд╣реЛрдЗрди) ред
</div>
</div>

<footer>
 <a href="income-demo.html">тмЕя╕П рдЖрдореНрджрд╛рдиреА рд╡рд┐рд╡рд░рдг</a>
  <span>Farmerbase BP Engine-Profit-Loss Detail</span>
  <a href="profit-distribution.html">рдирд╛рдлрд╛ рд╡рд┐рддрд░рдг</a>
</footer>

<script>
/* ================= LOAD DATA ================= */
const productions = JSON.parse(localStorage.getItem("productions")) || [];
const expenses = JSON.parse(localStorage.getItem("expenses")) || [];
const incomes = JSON.parse(localStorage.getItem("incomes")) || {};
const capitalSources = JSON.parse(localStorage.getItem("capitalSources")) || [];

/* ================= INTEREST ================= */
function totalInterest(){
 let sum = 0;
 capitalSources.forEach(s=>{
  if(s.interestRate){
   sum += (Number(s.amount)||0) * Number(s.interestRate)/100;
  }
 });
 return sum;
}

/* ================= CALCULATION ================= */
function calculatePL(){
 let totalIncome = 0;
 let totalVariable = 0;
 let totalDep = 0;

 productions.forEach(p=>{
  const inc = incomes[p.id];
  if(!inc) return;

  const qty = Number(p.quantity)||0;
  const profitPct = inc.profitPct||0;

  let prodCost = 0;

  expenses.forEach(e=>{
   if(!e.map || !e.map[p.id]) return;

   if(e.type==="variable"){
    const c = (e.qty*e.rate)||0;
    prodCost += c;
    totalVariable += c;
   }else{
    const d = (e.qty*e.rate)/(e.life||1);
    prodCost += d;
    totalDep += d;
   }
  });

  const costPerUnit = qty ? prodCost/qty : 0;
  const sellingRate = costPerUnit * (1 + profitPct/100);
  const sales = sellingRate * qty;

  totalIncome += sales;
 });

 const operatingProfit = totalIncome - totalVariable - totalDep;
 const interest = totalInterest();
 const netProfit = operatingProfit - interest;

 return {
  totalIncome,
  totalVariable,
  totalDep,
  operatingProfit,
  interest,
  netProfit
 };
}

/* ================= RENDER ================= */
function render(){
 const r = calculatePL();

 document.getElementById("totalIncome").innerText = r.totalIncome.toFixed(2);
 document.getElementById("totalVariable").innerText = r.totalVariable.toFixed(2);
 document.getElementById("totalDep").innerText = r.totalDep.toFixed(2);
 document.getElementById("operatingProfit").innerText = r.operatingProfit.toFixed(2);
 document.getElementById("totalInterest").innerText = r.interest.toFixed(2);

 const np = document.getElementById("netProfit");
 np.innerText = r.netProfit.toFixed(2);
 np.className = r.netProfit >= 0 ? "pos" : "neg";

 document.getElementById("plBody").innerHTML = `
<tr><td>рдХреБрд▓ рдЖрдореНрджрд╛рдиреА</td><td>${r.totalIncome.toFixed(2)}</td></tr>
<tr><td>рдХреБрд▓ рдЪрд╛рд▓реБ рдЦрд░реНрдЪ</td><td>${r.totalVariable.toFixed(2)}</td></tr>
<tr><td>рдХреБрд▓ рд╡рд╛рд░реНрд╖рд┐рдХ рд╣реНрд░рд╛рд╕</td><td>${r.totalDep.toFixed(2)}</td></tr>
<tr><th>рд╕рдЮреНрдЪрд╛рд▓рди рдирд╛рдлрд╛</th><th>${r.operatingProfit.toFixed(2)}</th></tr>
<tr><td>рд╡реНрдпрд╛рдЬ рдЦрд░реНрдЪ</td><td>${r.interest.toFixed(2)}</td></tr>
<tr><th>рд╢реБрджреНрдз рдирд╛рдлрд╛ / рдиреЛрдХреНрд╕рд╛рди</th><th>${r.netProfit.toFixed(2)}</th></tr>
`;
}

render();
</script>

</body>
</html>
