<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<title>Expense Entry | BPMS</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:"Noto Sans Devanagari","Kalimati","Mangal","Nirmala UI",system-ui,Arial;
  background:#f4f7f6;
  margin:0;
}

/* ===== CONTAINER ===== */
.container{
  max-width:1100px;
  margin:30px auto;
  background:#fff;
  padding:30px;
  border-radius:10px;
}

h2{
  margin-top:0;
  color:#2e7d32;
}

/* ===== CATEGORY ===== */
.category{
  border:1px solid #ddd;
  border-radius:8px;
  padding:15px;
  margin-top:22px;
}
.category h3{
  margin:0 0 10px 0;
}

/* ===== TABLE ===== */
table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  border:1px solid #ddd;
  padding:6px;
  text-align:center;
}
th{
  background:#f0f0f0;
}

input,textarea{
  width:100%;
  padding:6px;
  font-family:inherit;
}
textarea{min-height:40px}

button{
  padding:6px 12px;
  background:#1b5e20;
  color:#fff;
  border:none;
  border-radius:5px;
  cursor:pointer;
}

.total{
  margin-top:25px;
  font-size:18px;
  font-weight:700;
}

/* ===== PRINT ===== */
@media print{
  button{display:none}
  body{background:#fff}
  .container{margin:0;padding:0}
}
</style>
</head>

<body>

<div class="container">
  <h2>üí∏ ‡§µ‡§æ‡§∞‡•ç‡§∑‡§ø‡§ï ‡§ñ‡§∞‡•ç‡§ö ‡§µ‡§ø‡§µ‡§∞‡§£</h2>

  <div id="categories"></div>

  <div class="total">
    ‡§ï‡•Å‡§≤ ‡§µ‡§æ‡§∞‡•ç‡§∑‡§ø‡§ï ‡§ñ‡§∞‡•ç‡§ö: ‡§∞‡•Å. <span id="grandTotal">0</span>
  </div>

  <button onclick="saveExpense()">üíæ Save Expense</button>
</div>

<script>
/* ===== FIXED EXPENSE CATEGORIES ===== */
const CATEGORY_LIST = [
  "‡•ß. ‡§Æ‡•á‡§∂‡§ø‡§®, ‡§î‡§ú‡§æ‡§∞, ‡§™‡•ç‡§∞‡§µ‡§ø‡§ß‡§ø ‡§§‡§•‡§æ ‡§∏‡§µ‡§æ‡§∞‡•Ä",
  "‡•®. ‡§™‡•Ç‡§∞‡•ç‡§µ‡§æ‡§ß‡§æ‡§∞ ‡§®‡§ø‡§∞‡•ç‡§Æ‡§æ‡§£",
  "‡•©. ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§ï‡§ö‡•ç‡§ö‡§æ ‡§™‡§¶‡§æ‡§∞‡•ç‡§• / ‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä",
  "‡•™. ‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞ ‡§§‡§•‡§æ ‡§∂‡•ç‡§∞‡§Æ‡§ø‡§ï ‡§ñ‡§∞‡•ç‡§ö",
  "‡•´. ‡§µ‡§ø‡§µ‡§ø‡§ß ‡§Ö‡§®‡•ç‡§Ø ‡§ñ‡§∞‡•ç‡§ö"
];

/* ===== RESTORE ACTIVE PROJECT ===== */
(function restoreActiveProject(){
  let key = localStorage.getItem("activeProject");
  if(!key) return;

  let d = JSON.parse(localStorage.getItem(key));
  if(!d) return;

  localStorage.setItem("expenseData", JSON.stringify(d.expenseData||[]));
})();

/* ===== RENDER ===== */
function render(){
  let wrap = document.getElementById("categories");
  wrap.innerHTML = "";

  let data = JSON.parse(localStorage.getItem("expenseData")||"[]");

  CATEGORY_LIST.forEach((cat,i)=>{
    let rows = data.filter(r=>r.category===cat);

    let html = `
      <div class="category">
        <h3>${cat}</h3>

        <table>
          <thead>
            <tr>
              <th>‡§ñ‡§∞‡•ç‡§ö ‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï</th>
              <th>‡§™‡§∞‡§ø‡§Æ‡§æ‡§£</th>
              <th>‡§¶‡§∞</th>
              <th>‡§∞‡§ï‡§Æ</th>
              <th>‡§π‡§ü‡§æ‡§â‡§®‡•á</th>
            </tr>
          </thead>
          <tbody id="tbody_${i}"></tbody>
        </table>

        <textarea id="note_${i}" placeholder="‡§Ø‡§∏ ‡§ï‡•ç‡§Ø‡§æ‡§ü‡•á‡§ó‡•ã‡§∞‡•Ä‡§ï‡•ã ‡§ü‡§ø‡§™‡•ç‡§™‡§£‡•Ä / ‡§µ‡§ø‡§µ‡§∞‡§£ (optional)"></textarea>
        <br><br>
        <button onclick="addRow('${cat}',${i})">‚ûï ‡§ñ‡§∞‡•ç‡§ö ‡§•‡§™‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</button>
      </div>
    `;
    wrap.insertAdjacentHTML("beforeend",html);

    rows.forEach(r=>addRow(cat,i,r));
  });

  calculateTotal();
}

/* ===== ADD ROW ===== */
function addRow(category,index,rowData={}){
  let tb = document.getElementById("tbody_"+index);
  let tr = document.createElement("tr");

  tr.innerHTML = `
    <td><input value="${rowData.title||""}"></td>
    <td><input type="number" value="${rowData.qty||""}" oninput="calcRow(this)"></td>
    <td><input type="number" value="${rowData.rate||""}" oninput="calcRow(this)"></td>
    <td class="amount">0</td>
    <td><button onclick="this.parentElement.parentElement.remove();calculateTotal()">‚úñ</button></td>
  `;
  tb.appendChild(tr);

  calcRow(tr.querySelector("input[type=number]"));
}

/* ===== CALC ROW ===== */
function calcRow(el){
  let tr = el.parentElement.parentElement;
  let qty = parseFloat(tr.children[1].querySelector("input").value)||0;
  let rate = parseFloat(tr.children[2].querySelector("input").value)||0;
  tr.querySelector(".amount").innerText = qty*rate;
  calculateTotal();
}

/* ===== TOTAL ===== */
function calculateTotal(){
  let total = 0;
  document.querySelectorAll(".amount").forEach(td=>{
    total += parseFloat(td.innerText)||0;
  });
  document.getElementById("grandTotal").innerText = total;
}

/* ===== SAVE ===== */
function saveExpense(){
  let result = [];

  CATEGORY_LIST.forEach((cat,i)=>{
    let tb = document.getElementById("tbody_"+i);
    [...tb.rows].forEach(r=>{
      result.push({
        category:cat,
        title:r.cells[0].querySelector("input").value,
        qty:r.cells[1].querySelector("input").value,
        rate:r.cells[2].querySelector("input").value,
        amount:r.cells[3].innerText
      });
    });
  });

  localStorage.setItem("expenseData", JSON.stringify(result));
  localStorage.setItem("totalExpense", document.getElementById("grandTotal").innerText);

  let key = localStorage.getItem("activeProject");
  if(key){
    let p = JSON.parse(localStorage.getItem(key));
    if(p){
      p.expenseData = result;
      p.totalExpense = document.getElementById("grandTotal").innerText;
      localStorage.setItem(key, JSON.stringify(p));
    }
  }

  alert("‡§ñ‡§∞‡•ç‡§ö ‡§µ‡§ø‡§µ‡§∞‡§£ Save ‡§≠‡§Ø‡•ã");
}

window.onload = render;
</script>

</body>
</html>
