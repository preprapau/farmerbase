<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<title>Expenses тАУ Stable Core</title>

<style>
body{font-family:Arial;background:#f5f5f5;margin:0}
header,footer{
 background:#2e7d32;color:#fff;
 padding:12px 20px;
 display:flex;justify-content:space-between;align-items:center
}
header a,footer a{color:#fff;text-decoration:none;font-weight:bold}

.container{max-width:1400px;margin:auto;background:#fff;padding:20px}

h2{margin-top:30px}

table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ccc;padding:6px;text-align:center;font-size:14px}
th{background:#e8f5e9}

input{width:100%;box-sizing:border-box}

.mapBox{text-align:left;font-size:13px}

.btn{padding:6px 10px;border:none;cursor:pointer}
.add{background:#2e7d32;color:#fff}
.del{background:#c62828;color:#fff}

.preview{
 background:#f1f8e9;
 padding:12px;
 margin-top:20px;
 font-size:14px
}
</style>
</head>

<body>

<header>
 <a href="production.html">тмЕя╕П рдЙрддреНрдкрд╛рджрди рд╡рд┐рд╡рд░рдг</a>
 <span>рдЦрд░реНрдЪ рд╡рд┐рд╡рд░рдг (Stable)</span>
 <a href="capital-source.html">рдкреБрдБрдЬрд┐рдХреЛ рд╕реНрд░реЛрдд тЮбя╕П</a>
</header>

<div class="container">

<h2>ЁЯФД рдЪрд╛рд▓реБ рдЦрд░реНрдЪ</h2>
<table>
<thead>
<tr>
 <th>рдЦрд░реНрдЪ рд╢реАрд░реНрд╖рдХ</th>
 <th>рдЗрдХрд╛рдИ</th>
 <th>рдкрд░рд┐рдорд╛рдг</th>
 <th>рджрд░</th>
 <th>рдЬрдореНрдорд╛</th>
 <th>рдХреБрди рдЙрддреНрдкрд╛рджрдирдорд╛</th>
 <th>ЁЯЧСя╕П</th>
</tr>
</thead>
<tbody id="varBody"></tbody>
</table>
<button class="btn add" onclick="addExpense('variable')">тЮХ рдЪрд╛рд▓реБ рдЦрд░реНрдЪ рдердкреНрдиреБрд╣реЛрд╕реН</button>

<h2>ЁЯПЧя╕П рд╕реНрдерд┐рд░ рдЦрд░реНрдЪ</h2>
<table>
<thead>
<tr>
 <th>рдЦрд░реНрдЪ рд╢реАрд░реНрд╖рдХ</th>
 <th>рдЗрдХрд╛рдИ</th>
 <th>рдкрд░рд┐рдорд╛рдг</th>
 <th>рджрд░</th>
 <th>рдЖрдпреБ</th>
 <th>рд╡рд╛рд░реНрд╖рд┐рдХ рд╣реНрд░рд╛рд╕</th>
 <th>рдХреБрди рдЙрддреНрдкрд╛рджрдирдорд╛</th>
 <th>ЁЯЧСя╕П</th>
</tr>
</thead>
<tbody id="fixBody"></tbody>
</table>
<button class="btn add" onclick="addExpense('fixed')">тЮХ рд╕реНрдерд┐рд░ рдЦрд░реНрдЪ рдердкреНрдиреБрд╣реЛрд╕реН</button>

<div class="preview" id="previewBox"></div>

</div>

<footer>
 <span>FarmerBase BP Engine тАУ Expenses Stable Core</span>
</footer>

<script>
/* ========= DATA ========= */
const productions =
 JSON.parse(localStorage.getItem("productions")) || [];

let expenses =
 JSON.parse(localStorage.getItem("expenses")) || [];

/* ========= SAVE ========= */
function save(){
 localStorage.setItem("expenses",JSON.stringify(expenses));
}

/* ========= ADD ========= */
function addExpense(type){
 expenses.push({
  id:Date.now(),
  type,
  title:"",
  unit:"",
  qty:0,
  rate:0,
  life: type==="fixed"?1:null,
  map:{}
 });
 save();
 render();
}

/* ========= DELETE ========= */
function delExp(id){
 expenses = expenses.filter(e=>e.id!==id);
 save();
 render();
}

/* ========= MAP ========= */
function mapUI(exp){
 if(!productions.length) return "рдЙрддреНрдкрд╛рджрди рдЫреИрди";
 return productions.map(p=>{
  const chk = exp.map[p.id]?"checked":"";
  return `
<label>
 <input type="checkbox" ${chk}
  onchange="toggleMap(${exp.id},'${p.id}',this.checked)">
 ${p.name}
</label><br>`;
 }).join("");
}

function toggleMap(eid,pid,val){
 const e=expenses.find(x=>x.id===eid);
 if(val) e.map[pid]=true;
 else delete e.map[pid];
 save();
}

/* ========= INPUT BIND ========= */
function bindInput(inp,exp,field){
 inp.value = exp[field]||"";
 inp.oninput = ()=>{ exp[field]=inp.value; save(); };
}

/* ========= RENDER ========= */
function render(){
 let vSum=0,fDep=0;
 const vb=document.getElementById("varBody");
 const fb=document.getElementById("fixBody");
 vb.innerHTML=""; fb.innerHTML="";

 expenses.forEach(e=>{
  if(e.type==="variable"){
   const t=e.qty*e.rate||0; vSum+=t;
   const tr=document.createElement("tr");
   tr.innerHTML=`
<td><input></td>
<td><input></td>
<td><input type="number"></td>
<td><input type="number"></td>
<td>${t.toFixed(2)}</td>
<td class="mapBox">${mapUI(e)}</td>
<td><button class="btn del">ЁЯЧСя╕П</button></td>`;
   const ins=tr.querySelectorAll("input");
   bindInput(ins[0],e,"title");
   bindInput(ins[1],e,"unit");
   ins[2].value=e.qty; ins[3].value=e.rate;
   ins[2].oninput=()=>{e.qty=+ins[2].value||0;save()};
   ins[3].oninput=()=>{e.rate=+ins[3].value||0;save()};
   tr.querySelector("button").onclick=()=>delExp(e.id);
   vb.appendChild(tr);
  }

  if(e.type==="fixed"){
   const total=e.qty*e.rate||0;
   const dep=total/(e.life||1)||0;
   fDep+=dep;
   const tr=document.createElement("tr");
   tr.innerHTML=`
<td><input></td>
<td><input></td>
<td><input type="number"></td>
<td><input type="number"></td>
<td><input type="number"></td>
<td>${dep.toFixed(2)}</td>
<td class="mapBox">${mapUI(e)}</td>
<td><button class="btn del">ЁЯЧСя╕П</button></td>`;
   const ins=tr.querySelectorAll("input");
   bindInput(ins[0],e,"title");
   bindInput(ins[1],e,"unit");
   ins[2].value=e.qty; ins[3].value=e.rate; ins[4].value=e.life;
   ins[2].oninput=()=>{e.qty=+ins[2].value||0;save()};
   ins[3].oninput=()=>{e.rate=+ins[3].value||0;save()};
   ins[4].oninput=()=>{e.life=+ins[4].value||1;save()};
   tr.querySelector("button").onclick=()=>delExp(e.id);
   fb.appendChild(tr);
  }
 });

 document.getElementById("previewBox").innerHTML =
  `<b>Summary:</b><br>
   рдХреБрд▓ рдЪрд╛рд▓реБ рдЦрд░реНрдЪ: ${vSum.toFixed(2)}<br>
   рдХреБрд▓ рд╡рд╛рд░реНрд╖рд┐рдХ рд╣реНрд░рд╛рд╕: ${fDep.toFixed(2)}`;
}

render();
</script>

</body>
</html>
